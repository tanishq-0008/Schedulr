<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Schedulr</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header class="dashboard-header">
            <h1>Welcome, {{ user.username }}!</h1>
            <a href="{{ url_for('login') }}" class="btn btn-secondary">Logout</a>
        </header>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <div class="dashboard-content">
            <!-- Upcoming Exams (read-only, mentor-set) -->
            {% if upcoming_exams %}
            <section class="sessions-section exams-section">
                <h2>Upcoming Exams</h2>
                <div class="exams-list">
                    {% for exam in upcoming_exams %}
                    <div class="exam-card">
                        <strong>{{ exam.subject }}: {{ exam.unit_name }} - {{ exam.topic_name }}</strong>
                        <span class="exam-date">{{ exam.exam_date[:10] }}</span>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- Dynamically Generated Suggested Study Schedule -->
            {% if suggested_schedule %}
            <section class="sessions-section schedule-section">
                <h2>Suggested Study Schedule</h2>
                <p class="schedule-desc">Based on topics completed, topics missed, test performance, and upcoming exams.</p>
                <div class="schedule-list">
                    {% for item in suggested_schedule %}
                    <div class="schedule-card {% if item.completed and item.test_taken %}done{% endif %}">
                        <div class="schedule-header">
                            <h3>{{ item.unit.subject }}: {{ item.unit.unit_name }} - {{ item.unit.topic_name }}</h3>
                            <span class="reason-badge">{{ item.reason }}</span>
                        </div>
                        <p class="suggested-time"><strong>Suggested time:</strong> {{ item.suggested_study_time[:16].replace('T', ' ') }}</p>
                        {% if not item.completed or not item.test_taken %}
                        <form method="POST" action="{{ url_for('mark_schedule_complete', unit_id=item.unit_id) }}" style="display: inline;">
                            <input type="hidden" name="user_id" value="{{ user.id }}">
                            <input type="hidden" name="suggested_study_time" value="{{ item.suggested_study_time }}">
                            <button type="submit" class="btn btn-small btn-success">Mark Session Complete</button>
                        </form>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- Assigned Units/Topics from Mentor -->
            <section class="sessions-section units-section">
                <h2>Assigned Units & Topics</h2>
                {% if units %}
                    <div class="units-list">
                        {% for unit in units %}
                        <div class="unit-card">
                            <div class="unit-header">
                                <h3>{{ unit.subject }}: {{ unit.unit_name }} - {{ unit.topic_name }}</h3>
                                {% set prog = progress_map.get(unit.id) %}
                                <span class="status-badge {% if prog and prog.completed %}completed{% else %}pending{% endif %}">
                                    {% if prog and prog.completed %}Completed{% else %}Not Started{% endif %}
                                </span>
                            </div>
                            <div class="unit-actions">
                                {% if not prog or not prog.completed %}
                                <form method="POST" action="{{ url_for('mark_unit_complete', unit_id=unit.id) }}" style="display: inline;">
                                    <input type="hidden" name="user_id" value="{{ user.id }}">
                                    <button type="submit" class="btn btn-small btn-success">Mark as Completed</button>
                                </form>
                                {% endif %}
                                {% if unit.test_id %}
                                    {% if not prog or not prog.test_taken %}
                                    <a href="{{ url_for('take_test', test_id=unit.test_id, user_id=user.id) }}" class="btn btn-small btn-primary">Take Test</a>
                                    {% else %}
                                    <span class="score-badge">Score: {{ "%.1f"|format(prog.test_score) }}%</span>
                                    {% endif %}
                                {% else %}
                                    <span class="no-test">No test available</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="no-sessions">No units assigned yet. Ask your mentor to add units.</p>
                {% endif %}
            </section>

            <!-- Add/Edit Session Form -->
            <section class="form-section">
                <h2 id="form-title">Add New Study Session</h2>
                <form id="session-form" method="POST" action="{{ url_for('add_session') }}" class="session-form">
                    <input type="hidden" name="user_id" value="{{ user.id }}">
                    <input type="hidden" id="edit-session-id" name="session_id" value="">
                    
                    <div class="form-group">
                        <label for="subject">Subject:</label>
                        <input type="text" id="subject" name="subject" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="start_time">Date & Time:</label>
                        <input type="datetime-local" id="start_time" name="start_time" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Notes:</label>
                        <textarea id="notes" name="notes" rows="3"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" id="submit-btn" class="btn btn-primary">Add Session</button>
                        <button type="button" id="cancel-btn" class="btn btn-secondary" style="display: none;" onclick="resetForm()">Cancel</button>
                    </div>
                </form>
            </section>
            
            <!-- Sessions List -->
            <section class="sessions-section">
                <h2>My Study Sessions</h2>
                {% if sessions %}
                    <div class="sessions-list">
                        {% for session in sessions %}
                            <div class="session-card {% if session.completed %}completed{% endif %}">
                                <div class="session-header">
                                    <h3>{{ session.subject }}</h3>
                                    <span class="status-badge {% if session.completed %}completed{% else %}pending{% endif %}">
                                        {% if session.completed %}Completed{% else %}Pending{% endif %}
                                    </span>
                                </div>
                                
                                <div class="session-details">
                                    <p><strong>Date & Time:</strong> {{ session.start_time.replace('T', ' ') }}</p>
                                    {% if session.notes %}
                                        <p><strong>Notes:</strong> {{ session.notes }}</p>
                                    {% endif %}
                                </div>
                                
                                <div class="session-actions">
                                    <form method="POST" action="{{ url_for('mark_completed', session_id=session.id) }}" style="display: inline;">
                                        <input type="hidden" name="user_id" value="{{ user.id }}">
                                        <button type="submit" class="btn btn-small {% if session.completed %}btn-secondary{% else %}btn-success{% endif %}">
                                            {% if session.completed %}Mark as Pending{% else %}Mark as Completed{% endif %}
                                        </button>
                                    </form>
                                    
                                    <button onclick="editSession({{ session.id }}, '{{ session.subject }}', '{{ session.start_time }}', '{{ session.notes|replace("'", "\\'") }}')" 
                                            class="btn btn-small btn-primary">Edit</button>
                                    
                                    <form method="POST" action="{{ url_for('delete_session', session_id=session.id) }}" 
                                          style="display: inline;" 
                                          onsubmit="return confirm('Are you sure you want to delete this session?');">
                                        <input type="hidden" name="user_id" value="{{ user.id }}">
                                        <button type="submit" class="btn btn-small btn-danger">Delete</button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="no-sessions">No study sessions scheduled yet. Add one above!</p>
                {% endif %}
            </section>
        </div>
    </div>
    
    <script>
        function editSession(id, subject, startTime, notes) {
            // Set form to edit mode
            document.getElementById('form-title').textContent = 'Edit Study Session';
            document.getElementById('edit-session-id').value = id;
            document.getElementById('subject').value = subject;
            document.getElementById('start_time').value = startTime;
            document.getElementById('notes').value = notes || '';
            document.getElementById('submit-btn').textContent = 'Update Session';
            document.getElementById('cancel-btn').style.display = 'inline-block';
            
            // Change form action
            document.getElementById('session-form').action = '{{ url_for("edit_session", session_id=0) }}'.replace('/0', '/' + id);
            
            // Scroll to form
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        function resetForm() {
            // Reset form to add mode
            document.getElementById('form-title').textContent = 'Add New Study Session';
            document.getElementById('edit-session-id').value = '';
            document.getElementById('subject').value = '';
            document.getElementById('start_time').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('submit-btn').textContent = 'Add Session';
            document.getElementById('cancel-btn').style.display = 'none';
            
            // Reset form action
            document.getElementById('session-form').action = '{{ url_for("add_session") }}';
        }
        
        // Form validation
        document.getElementById('session-form').addEventListener('submit', function(e) {
            const subject = document.getElementById('subject').value.trim();
            const startTime = document.getElementById('start_time').value;
            
            if (!subject || !startTime) {
                e.preventDefault();
                alert('Please fill in all required fields');
                return false;
            }
            
            // Validate date is not in the past (optional check)
            const selectedDate = new Date(startTime);
            const now = new Date();
            if (selectedDate < now) {
                if (!confirm('The selected date is in the past. Continue anyway?')) {
                    e.preventDefault();
                    return false;
                }
            }
        });
    </script>
</body>
</html>
